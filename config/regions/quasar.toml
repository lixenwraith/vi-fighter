# === Quasar region states ===
# spawned dynamically via SpawnRegion action

# --- QUASAR CYCLE ---

[states.QuasarCycle]
parent = "Root"

[states.QuasarFuse]
parent = "QuasarCycle"
on_enter = [
    { action = "EmitEvent", event = "EventDrainPause" },
    { action = "EmitEvent", event = "EventGrayoutStart" },
    { action = "EmitEvent", event = "EventFuseQuasarRequest" },
]
transitions = [
    { trigger = "EventQuasarSpawned", target = "QuasarGoldSpawn" },
]

[states.QuasarGoldSpawn]
parent = "QuasarCycle"
on_enter = [
    { action = "EmitEvent", event = "EventGoldSpawnRequest" },
]
transitions = [
    { trigger = "Tick", target = "QuasarFail", guard = "StatusIntCompare", guard_args = { key = "heat.current", op = "eq", value = "0" } },
    { trigger = "EventHeatBurstNotification", target = "QuasarDustAll" },
    { trigger = "EventGoldSpawned", target = "QuasarGoldActive" },
    { trigger = "EventGoldSpawnFailed", target = "QuasarGoldRetry" },
    { trigger = "EventQuasarDestroyed", target = "QuasarExit" },
]

[states.QuasarGoldRetry]
parent = "QuasarCycle"
transitions = [
    { trigger = "Tick", target = "QuasarFail", guard = "StatusIntCompare", guard_args = { key = "heat.current", op = "eq", value = "0" } },
    { trigger = "EventHeatBurstNotification", target = "QuasarDustAll" },
    { trigger = "Tick", target = "QuasarGoldSpawn", guard = "StateTimeExceeds", guard_args = { ms = 100 } },
    { trigger = "EventQuasarDestroyed", target = "QuasarExit" },
]

[states.QuasarGoldActive]
parent = "QuasarCycle"
transitions = [
    { trigger = "Tick", target = "QuasarFail", guard = "StatusIntCompare", guard_args = { key = "heat.current", op = "eq", value = "0" } },
    { trigger = "EventHeatBurstNotification", target = "QuasarDustAll" },
    { trigger = "EventGoldTimeout", target = "QuasarGoldSpawn" },
    { trigger = "EventGoldDestroyed", target = "QuasarGoldSpawn" },
    { trigger = "EventQuasarDestroyed", target = "QuasarExit" },
]

# --- DUST ALL ---
# Overheat burst

[states.QuasarDustAll]
parent = "QuasarCycle"
on_enter = [
    { action = "EmitEvent", event = "EventDustAllRequest"},
    { action = "EmitEvent", event = "EventGrayoutEnd" },
    { action = "EmitEvent", event = "EventGoldCancel" },
    { action = "EmitEvent", event = "EventDrainResume" },
    { action = "SpawnRegion", region = "maze", initial_state = "MazeSetup" },
    { action = "PauseRegion", region = "quasar" },
]
transitions = [
    { trigger = "Tick", target = "QuasarFail", guard = "StatusIntCompare", guard_args = { key = "heat.current", op = "eq", value = "0" } },
    { trigger = "EventQuasarDestroyed", target = "QuasarExit" },
]

# --- QUASAR END ---

[states.QuasarFail]
parent = "QuasarCycle"
on_enter = [
    { action = "EmitEvent", event = "EventQuasarCancelRequest" },
]
transitions = [
    { trigger = "Tick", target = "QuasarExit" },
]

# --- MAIN HANDOFF ---

[states.QuasarExit]
parent = "QuasarCycle"
on_enter = [
    { action = "EmitEvent", event = "EventDrainResume" },
    { action = "EmitEvent", event = "EventGrayoutEnd" },
    { action = "EmitEvent", event = "EventGoldCancel" },
    { action = "ResumeRegion", region = "main" },
    { action = "TerminateRegion", region = "quasar" },
]