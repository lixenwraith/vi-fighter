# Quasar region: gold cycle during quasar with escalation to storm

[states.QuasarFuse]
parent = "Root"
on_enter = [
    { action = "EmitEvent", event = "EventGrayoutStart" },
    { action = "EmitEvent", event = "EventStrobeRequest", payload = { intensity = 0.8, duration_ms = 200 } },
    { action = "EmitEvent", event = "EventDrainPause" },
    { action = "EmitEvent", event = "EventFuseQuasarRequest" },
]
transitions = [
    { trigger = "EventQuasarSpawned", target = "QuasarGoldSpawn" },
    # Defensive: spawn never arrived
    { trigger = "Tick", target = "QuasarExit", guard = "StateTimeExceeds", guard_args = { ms = 5000 } },
]

# --- Gold Cycle Parent ---

[states.QuasarGoldCycle]
parent = "Root"
on_exit = [
    { action = "EmitEvent", event = "EventGoldCancel" },
]
transitions = [
    { trigger = "EventQuasarDestroyed", target = "QuasarEscalate", guard = "StatusIntCompare", guard_args = { key = "kills.quasar", op = "gte", value = 3 } },
    { trigger = "EventQuasarDestroyed", target = "QuasarExit" },
    { trigger = "Tick", target = "QuasarEscalate", guard = "StatusIntCompare", guard_args = { key = "kills.quasar", op = "gte", value = 3 } },
    # Defensive: quasar died OOB without emitting destroy event
    { trigger = "Tick", target = "QuasarExit", guard = "And", guard_args = { guards = [
        { name = "StateTimeExceeds", args = { ms = 2000 } },
        { name = "StatusBoolEquals", args = { key = "quasar.active", value = false } },
    ] } },
]

# --- Gold Spawn ---

[states.QuasarGoldSpawn]
parent = "QuasarGoldCycle"
on_enter = [
    { action = "EmitEvent", event = "EventGoldSpawnRequest" },
]
transitions = [
    { trigger = "EventGoldSpawned", target = "QuasarGoldActive" },
    { trigger = "EventGoldSpawnFailed", target = "QuasarGoldSpawnRetry" },
    # Defensive: quasar died OOB without emitting destroy event
    { trigger = "Tick", target = "QuasarExit", guard = "And", guard_args = { guards = [
        { name = "StateTimeExceeds", args = { ms = 2000 } },
        { name = "StatusBoolEquals", args = { key = "quasar.active", value = false } },
    ] } },
]

[states.QuasarGoldSpawnRetry]
parent = "QuasarGoldCycle"
transitions = [
    { trigger = "Tick", target = "QuasarGoldSpawn", guard = "StateTimeExceeds", guard_args = { ms = 100 } },
]

# --- Gold Active ---

[states.QuasarGoldActive]
parent = "QuasarGoldCycle"
transitions = [
    { trigger = "EventGoldComplete", target = "QuasarGoldComplete" },
    { trigger = "EventGoldTimeout", target = "QuasarGoldTimeout" },
    { trigger = "EventGoldDestroyed", target = "QuasarGoldDestroyed" },
    # Defensive: quasar died OOB without emitting destroy event
    { trigger = "Tick", target = "QuasarExit", guard = "And", guard_args = { guards = [
        { name = "StateTimeExceeds", args = { ms = 2000 } },
        { name = "StatusBoolEquals", args = { key = "quasar.active", value = false } },
    ] } },
]

[states.QuasarGoldComplete]
parent = "QuasarGoldCycle"
on_enter = [
    { action = "EmitEvent", event = "EventHeatAddRequest", payload = { delta = 100 } },
    { action = "EmitEvent", event = "EventEnergyAddRequest", payload = { delta = 1000, type = 1 } },
]
transitions = [
    { trigger = "Tick", target = "QuasarDustAll" },
]

[states.QuasarGoldTimeout]
parent = "QuasarGoldCycle"
transitions = [
    { trigger = "Tick", target = "QuasarDustAll" }
]

[states.QuasarGoldDestroyed]
parent = "QuasarGoldCycle"
transitions = [
    { trigger = "Tick", target = "QuasarDustAll" },
]

# --- Dust ---

[states.QuasarDustAll]
parent = "QuasarGoldCycle"
on_enter = [
    { action = "EmitEvent", event = "EventDustAllRequest" },
]
transitions = [
    { trigger = "Tick", target = "QuasarGoldSpawn" },
]

# --- Exit Conditions ---

[states.QuasarExit]
parent = "Root"
on_enter = [
    { action = "EmitEvent", event = "EventGrayoutEnd" },
    { action = "EmitEvent", event = "EventDrainResume" },
    { action = "ResumeRegion", region = "main" },
    { action = "TerminateRegion", region = "quasar" },
]

[states.QuasarEscalate]
parent = "Root"
on_enter = [
    { action = "ResetStatusInt", payload = { key = "kills.quasar" } },
    { action = "EmitEvent", event = "EventGrayoutEnd" },
    { action = "EmitEvent", event = "EventQuasarCancelRequest" },
    { action = "SpawnRegion", region = "storm", initial_state = "StormSetup" },
    { action = "TerminateRegion", region = "quasar" },
]